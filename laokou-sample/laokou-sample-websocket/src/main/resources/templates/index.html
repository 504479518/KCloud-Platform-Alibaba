<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>WebSocket测试</title>
</head>
<body>
<label for="clientId">
    <input type="text" id="clientId">
</label>
<button id="btn1" onclick="connect()">连接</button>
<br/>
<label for="receiver">
    <input type="text" id="receiver">
</label>
<label for="payload">
    <input type="text" id="payload">
</label>
<button id="btn2" onclick="send()">发送</button>
</body>
<script>
    function connect() {

        let clientId = getClientId();

        if (clientId === "" || clientId === undefined || clientId === null) {
            alert("请输入ClientId")
            return
        }

        const socket = new WebSocket("ws://127.0.0.1:1112/ws")

        socket.onopen = function() {
            alert("连接成功")
            console.log("连接成功")
            socket.send(clientId)
        }

        socket.onmessage = function(event) {
            console.log("Received message from server: " + event.data)
        }

        socket.onerror = function(event) {
            alert("连接失败")
            console.log("连接失败", event)
        }

        socket.onclose = function() {
            alert("连接关闭")
            console.log("连接关闭")
        }
    }

    function send() {
        const data = {
            receiver: [getReceiver()],
            payload: getPayload()
        }
        const xhr = new XMLHttpRequest()
        xhr.open("POST", "http://127.0.0.1:9032/send", true)
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8")
        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                console.log("发送成功", xhr.responseText)
            } else if (xhr.readyState === 4) {
                console.error("发送失败", xhr.status, xhr.statusText)
            }
        }
        xhr.send(JSON.stringify(data))
    }

    function getClientId() {
        return document.getElementById("clientId").value
    }

    function getReceiver() {
        return document.getElementById("receiver").value
    }

    function getPayload() {
        return document.getElementById("payload").value
    }

</script>
</html>
